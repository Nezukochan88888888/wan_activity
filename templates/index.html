<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Classroom Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .hero-section {
            background: #0d6efd;
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .media-container {
            max-width: 900px;
            margin: 0 auto;
        }

        iframe,
        video {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div class="hero-section text-center">
        <h1>Classroom Hub</h1>
        <p class="lead" id="announcement">Loading announcement...</p>
    </div>

    <!-- 1. Selection Screen -->
    <div class="container text-center" id="setup-view">
        <div class="card p-5 shadow border-0" style="background: rgba(255,255,255,0.9);">
            <h2 class="mb-4">Select Your Assigned Group</h2>
            <div class="row g-3 justify-content-center">
                <div class="col-6 col-md-3"><button class="btn btn-outline-primary w-100 py-3 fw-bold"
                        onclick="selectGroup('1')">Group 1</button></div>
                <div class="col-6 col-md-3"><button class="btn btn-outline-primary w-100 py-3 fw-bold"
                        onclick="selectGroup('2')">Group 2</button></div>
                <div class="col-6 col-md-3"><button class="btn btn-outline-primary w-100 py-3 fw-bold"
                        onclick="selectGroup('3')">Group 3</button></div>
                <div class="col-6 col-md-3"><button class="btn btn-outline-primary w-100 py-3 fw-bold"
                        onclick="selectGroup('4')">Group 4</button></div>
            </div>
        </div>
    </div>

    <!-- 2. Main Activity Screen -->
    <div class="container d-none pb-5" id="activity-view">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="text-primary fw-bold" id="group-name-display">Group ?</h2>
            <span class="badge bg-success">Connected</span>
        </div>

        <div class="alert alert-info text-center" id="waiting-msg">
            <div class="spinner-border spinner-border-sm text-info me-2"></div>
            Waiting for teacher to start the activity...
        </div>

        <div id="media-content" class="d-none">
            <!-- Instructions Card -->
            <div class="card shadow-sm border-left-primary mb-4" style="border-left: 5px solid #0d6efd;">
                <div class="card-body">
                    <h5 class="card-title text-uppercase text-muted small fw-bold">Mission Instructions</h5>
                    <p class="card-text lead" id="instruction-display" style="white-space: pre-wrap;">Loading...</p>
                </div>
            </div>

            <!-- Resources Grid -->
            <h4 class="mb-3">üìö Resources & Notes</h4>
            <div class="row row-cols-1 row-cols-md-3 g-4" id="resource-grid">
                <!-- dynamic items -->
            </div>
        </div>
    </div>

    <!-- Media Modal -->
    <div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 text-center" id="modal-body-content">
                    <!-- Content injected here -->
                </div>
            </div>
        </div>
    </div>

    <div id="obsidian-style" class="d-none">
        <style>
            .markdown-body {
                background-color: #1e1e1e !important;
                color: #dcddde !important;
                font-family: 'Inter', sans-serif !important;
                line-height: 1.6;
                padding: 2rem;
                border-radius: 8px;
                text-align: left;
            }

            .markdown-body h1,
            .markdown-body h2,
            .markdown-body h3 {
                border-bottom: 1px solid #444;
                padding-bottom: 0.3em;
                color: #bfa1ff;
            }

            .markdown-body a {
                color: #8e8aff;
                text-decoration: none;
            }

            .markdown-body code {
                background-color: #2b2b2b;
                border-radius: 4px;
                padding: 0.2em 0.4em;
                font-family: monospace;
                color: #e6a5c1;
            }

            .markdown-body pre {
                background-color: #181818;
                padding: 1rem;
                border-radius: 8px;
                overflow-x: auto;
            }

            .markdown-body blockquote {
                border-left: 4px solid #bfa1ff;
                padding-left: 1rem;
                color: #888;
            }

            .markdown-body img {
                max-width: 100%;
                border-radius: 8px;
            }
        </style>
    </div>

    <footer class="mt-5 text-center text-muted small">
        <p>Classroom Hub v1.3 | Requires internet for initial CSS load</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/jszip.min.js"></script>
    <script src="/static/docx-preview.min.js"></script>
    <script src="/static/marked.min.js"></script>
    <script src="/static/purify.min.js"></script>
    <script>
        let selectedGroup = null;
        let lastState = {
            active: null,
            announcement: null,
            referencesHash: null // Simple way to track if list changed
        };

        function selectGroup(num) {
            selectedGroup = num;
            document.getElementById('setup-view').classList.add('d-none');
            document.getElementById('activity-view').classList.remove('d-none');
            document.getElementById('group-name-display').innerText = `Group ${num}`;

            // Inject styles once
            if (!document.getElementById('injected-styles')) {
                document.head.insertAdjacentHTML('beforeend', document.getElementById('obsidian-style').innerHTML);
                const div = document.createElement('div'); div.id = 'injected-styles'; document.body.appendChild(div);
            }

            checkStatus();
        }

        async function checkStatus() {
            try {
                // Fetch specific group data
                const response = await fetch(`/api/status?group_id=${selectedGroup}`);
                const data = await response.json();

                // 1. Check Announcement
                if (data.announcement !== lastState.announcement) {
                    document.getElementById('announcement').innerText = data.announcement;
                    lastState.announcement = data.announcement;
                }

                const contentDiv = document.getElementById('media-content'); // This is now unused, but kept for context if needed
                const waitingMsg = document.getElementById('waiting-msg');

                // 2. Check Activity State
                if (data.activity_active !== lastState.active) {
                    if (data.activity_active) {
                        waitingMsg.classList.add('d-none');
                        contentDiv.classList.remove('d-none'); // Correctly show wrapper
                    } else {
                        waitingMsg.classList.remove('d-none');
                        contentDiv.classList.add('d-none'); // Correctly hide wrapper
                        document.getElementById('resource-grid').innerHTML = '';
                        document.getElementById('instruction-display').innerText = "Follow teacher's verbal instructions.";
                    }
                    lastState.active = data.activity_active;
                }

                // 3. Render Group Content (Instructions + Resource Grid)
                if (data.activity_active && data.group_data) {
                    document.getElementById('instruction-display').innerText = data.group_data.instructions || "Follow teacher's verbal instructions.";

                    // Check if references changed (simple JSON string compare for quick hash)
                    const currentRefHash = JSON.stringify(data.group_data.references);
                    if (currentRefHash !== lastState.referencesHash) {
                        console.log("Resources changed, rendering grid...");
                        renderResourceGrid(data.group_data.references);
                        lastState.referencesHash = currentRefHash;
                    }
                }

            } catch (e) {
                console.error("Failed to fetch status", e);
            }
            setTimeout(checkStatus, 3000);
        }

        function renderResourceGrid(files) {
            const grid = document.getElementById('resource-grid');
            grid.innerHTML = '';

            if (!files || files.length === 0) {
                grid.innerHTML = '<p class="text-center text-muted">No resources available for your group yet.</p>';
                return;
            }

            files.forEach(f => {
                const col = document.createElement('div');
                col.className = 'col';
                let icon = 'üìÑ';
                let color = 'primary';

                if (f.type === 'pdf') { icon = 'üìï'; color = 'danger'; }
                if (f.type === 'video') { icon = 'üé¨'; color = 'dark'; }
                if (f.type === 'image') { icon = 'üñºÔ∏è'; color = 'success'; }
                if (f.type === 'markdown') { icon = 'üìì'; color = 'info'; }
                if (f.type === 'docx') { icon = 'üìù'; color = 'primary'; }

                col.innerHTML = `
                    <div class="card h-100 shadow-sm clickable-card" onclick="openMedia('${f.filename}', '${f.type}', '${f.name}')">
                        <div class="card-body text-center p-4">
                            <div class="display-4 mb-3">${icon}</div>
                            <h5 class="card-title text-truncate">${f.name}</h5>
                            <span class="badge bg-${color}">${f.type.toUpperCase()}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(col);
            });
        }

        const mediaModal = new bootstrap.Modal(document.getElementById('mediaModal'));

        function openMedia(filename, type, name) {
            const container = document.getElementById('modal-body-content');
            document.getElementById('modalLabel').innerText = name;
            container.innerHTML = 'Loading...';
            container.className = 'modal-body p-0'; // Reset styling

            const path = `/static/uploads/${filename}`;

            if (type === 'pdf') {
                container.innerHTML = `<iframe src="${path}" style="width:100%; height:80vh; border:none;"></iframe>`;
            } else if (type === 'video') {
                container.innerHTML = `<div class="p-2"><video controls playsinline style="max-width:100%; max-height:80vh;"><source src="${path}" type="video/mp4"></video></div>`;
            } else if (type === 'image') {
                container.innerHTML = `<div class="p-2"><img src="${path}" class="img-fluid" style="max-height:80vh;"></div>`;
            } else if (type === 'markdown') {
                container.className = 'modal-body text-start'; // Left align text
                container.innerHTML = `<div class="markdown-body p-4" id="md-content">Loading note...</div>`;
                fetch(path)
                    .then(r => {
                        if (!r.ok) throw new Error("File not found");
                        return r.text();
                    })
                    .then(txt => {
                        if (typeof marked === 'undefined') {
                            throw new Error("Markdown library missing. Please reload.");
                        }
                        document.getElementById('md-content').innerHTML = DOMPurify.sanitize(marked.parse(txt));
                    })
                    .catch(err => {
                        console.error(err);
                        document.getElementById('md-content').innerHTML = `<div class="p-4 text-danger">Error loading note: ${err.message}</div>`;
                    });
            } else if (type === 'docx') {
                container.innerHTML = `<div id="docx-view" class="bg-white text-dark p-4" style="min-height:80vh;">Rendering...</div>`;
                fetch(path).then(r => r.blob()).then(blob => {
                    docx.renderAsync(blob, document.getElementById('docx-view'));
                });
            } else {
                container.innerHTML = `<div class="p-5 text-center">Unrecognized file. <a href="${path}" download class="btn btn-primary">Download</a></div>`;
            }

            mediaModal.show();
        }

        // Stop video on close
        document.getElementById('mediaModal').addEventListener('hidden.bs.modal', () => {
            document.getElementById('modal-body-content').innerHTML = '';
        });
    </script>
</body>

</html>